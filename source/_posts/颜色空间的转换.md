---
title: 颜色空间的转换
categories: 渲染
mathjax: true
---
在[色彩空间介绍](https://silence394.github.io/2018/06/27/%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E4%BB%8B%E7%BB%8D/)文章中介绍了做渲染常用的色彩空间。颜色可以分为设备无关的颜色空间如CIE XYZ颜色空间和设备有关的颜色空间如常用的sRGB颜色空间。不同的设备可能会采用不同的颜色空间，我们希望看到的结果肯定是在PC上做出来的效果，到手机上显示的颜色是一致的。以设计师做出的图片为例，设计师作图常用空间为sRGB，是与设备有关的颜色空间。在手机上渲染时，可以将sRGB的颜色空间的颜色转换到与设备无关的CIE XYZ颜色空间，再转换到另外一个手机上的颜色空间，就能保证最终看到的效果是一样的。

### CIE RGB与CIE XYZ的转换
[色彩空间介绍](https://silence394.github.io/2018/06/27/%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E4%BB%8B%E7%BB%8D/)中说过，CIE XYZ空间实际上是由CIE RGB空间经过一个线性变化把色匹配函数的负值去掉了，二者其实线性空间。由CIE给出的空间转换公式如下。
RGB→XYZ：
$$
\begin{bmatrix}
X\\ 
Y\\ 
Z
\end{bmatrix}=
\begin{bmatrix}
2.7688 & 1.7517 & 1.1301\\
1.0 & 4.5906 & 0.0601\\
0.0 & 0.0565 & 5.5942
\end{bmatrix}
\cdot 
\begin{bmatrix}
R\\ 
G\\ 
B
\end{bmatrix}
$$
XYZ→RGB：
$$
\begin{bmatrix}
R\\ 
G\\ 
B
\end{bmatrix}=
\begin{bmatrix}
0.41847 & -0.15866 & -0.082835\\
-0.091169 & 0.25243 & 0.015708\\
0.0009209 & -0.0025498 & 0.17860
\end{bmatrix}
\cdot 
\begin{bmatrix}
X\\ 
Y\\ 
Z
\end{bmatrix}
$$

### CIE XYZ与sRGB空间的转换
定义RGB颜色空间需要的前提是，需要设定RGB三基色在CIE XYZ空间的坐标以及白色点的坐标。以sRGB空间为例，相关的参考点在XYZ空间的坐标如下：

参考点 | XYZ坐标
---|---
R | (0.64, 0.33, 0.03)
G | (0.3, 0.6, 0.10)
B | (0.15, 0.06, 0.79)
White(D65) | (0.9505, 1.0, 1.0888)

白色点的定义是为了使RGB = (1, 1, 1)的时候是白色，可以列出下面这个方程
$$
W = \omega_r R + \omega_g G + \omega_b B
$$
矩阵形式为：
$$
W = \begin{bmatrix}
R & G & B
\end{bmatrix}\omega
$$
得到ω为：

$$
\omega = \begin{bmatrix}
R & G & B
\end{bmatrix}^{-1}W
$$

对于sRGB空间，将上面的参考点代入，得
$$
\omega = \begin{bmatrix}
R & G & B
\end{bmatrix}^{-1}W = \begin{bmatrix}
 0.64& 0.3 & 0.15\\ 
 0.33&  0.6& 0.06\\ 
 0.03&  0.1& 0.79
\end{bmatrix}^{-1}\begin{bmatrix}
0.9505\\
1.0\\
1.0888
\end{bmatrix} =\begin{bmatrix}
0.6446\\
1.1919\\
1.2029 
\end{bmatrix}
$$
对于某一种颜色C = (x, y, z), 将sRGB校正后的RGB作为基，求C到sRGB的转换矩阵。
$$
C = r(\omega_rR) + g(\omega_gG) + b(\omega_bB)
$$
矩阵形式为：
$$
C_{XYZ} = \begin{bmatrix}
R & G & B
\end{bmatrix} \begin{bmatrix}
\omega_r & 0 & 0\\
0 & \omega_g & 0\\ 
 0& 0 & \omega_b
\end{bmatrix}\begin{bmatrix}
r\\ 
g\\ 
b
\end{bmatrix} = \begin{bmatrix}
\omega_rR & \omega_gG &\omega_bB 
\end{bmatrix}C_{sRGB}
$$

所以sRGB到XYZ的转换矩阵为：
$$
M_{sRGB→XYZ} = \begin{bmatrix}
\omega_rR & \omega_gG &\omega_bB 
\end{bmatrix} = \begin{bmatrix}
 0.64& 0.3 & 0.15\\ 
 0.33&  0.6& 0.06\\ 
 0.03&  0.1& 0.79
\end{bmatrix}\begin{bmatrix}
 0.6446& 0.0 & 0.0\\ 
 0.0&  1.1919& 0.0\\ 
 0.0&  0.0& 1.2029
\end{bmatrix}=
\begin{bmatrix}
0.4125& 0.3576 & 	0.1804\\ 
 0.2127&  0.7151& 0.0722\\ 
0.0193& 0.1192& 0.9503 
\end{bmatrix}
$$

XYZ到sRGB的转换矩阵为：
$$
M_{XYZ→sRGB} =
M_{sRGB→XYZ}^{-1} =
\begin{bmatrix}
 3.2402& -1.5373 & -0.4983\\ 
-0.9694&  1.8763 & 0.0415\\ 
 0.0558&  -0.2041& 1.0572
\end{bmatrix}
$$

由CIEXYZ空间转换到sRGB空间之后，得到的值是线性的。还需要进行gamma校正才能被显示器正确的显示。每个RGB空间对应的gamma校正的公式不一致，大多数都是$C = C_{\text{lin}}^{1/\gamma}$，其中γ=2.2。Wiki上给出的sRGB空间的gamma校正公式为：
$$
C_{\mathrm {srgb} }={\begin{cases}12.92C_{\mathrm {linear} },&C_{\mathrm {linear} }\leq 0.0031308\\1.055C_{\mathrm {linear} }^{1/2.4}-0.055,&C_{\mathrm {linear} }>0.0031308\end{cases}}
$$
而当sRGB的颜色空间需要做线性运算的时候，在转换到XYZ空间之前，需要对sRGB空间的颜色做gamma校正。
$$
C_{\mathrm {linear} }={\begin{cases}{\frac {C_{\mathrm {srgb} }}{12.92}},&C_{\mathrm {srgb} }\leq 0.04045\\\left({\frac {C_{\mathrm {srgb} }+0.055}{1.055}}\right)^{2.4},&C_{\mathrm {srgb} }>0.04045\end{cases}}
$$

由sRGB和CIE XYZ空间的正确相互转换转换，才能保证在如今的HDR和基于物理的渲染下，得到正确的渲染效果。

### 参考
1. http://www.brucelindbloom.com/index.html?Eqn_ChromAdapt.html
2. http://www.brucelindbloom.com/index.html?Eqn_RGB_XYZ_Matrix.html
3. https://en.wikipedia.org/wiki/SRGB
4. https://zhuanlan.zhihu.com/p/24281841