---
title: 基于物理的渲染——间接光照
categories: 渲染
mathjax: true
---

在前面的文章中我们已经给出了基于物理的渲染方程：
$$
L_o = \int_{\Omega }f_r(\omega_i, \omega_o)\otimes L_i(\omega_i)\cos\theta_id\omega_i
$$
并介绍了直接光照的实现。然而在自然界中，一个物体不会单独存在，光源会照射到其他的物体上，反射的光会有一部分反射到物体上。为了模拟这种环境光照的形式，我们通过环境贴图来保存周围的环境信息，并通过PBR的渲染公式来实现间接光照。
这种光照也叫基于图像的渲染 （Image Based Lighting，简称IBL）。
### 蒙特卡洛方法
#### 概率密度函数
随机变量X用来表示随机事件。随机变量的值用小些字母表示，如x，称为为随机数。随机变量的输入集合也可以是另一种随机变量，这时我们将服从一种分布的随机变量转换为服从另一种分布的随机变量，如$Y = f(X)$。

随机变量X的每个值x都关联着每次样本抽样时这个值出现的概率，随机变量所有可能值组成的概率分布函数称为概率密度函数（probability density function，简称为pdf），用$p$表示。

在渲染方程中我们用到的随机变量都是连续型随机变量。随机连续变量X期望的期望为：
$$
E[X] = \int xp(x)dx
$$
通常我们求的是与随机变量相关的函数$Y = f(X)$，Y的期望为：
$$
E[Y] = E[f(X)] = \int f(x)p(x)dx
$$

#### 大数定律
我们对随机变量X重复N次抽样，形成一系列的独立同分布的随机数，然后通过对这些随机数进行统计计数来近似上述的期望模型，这就是估计。
$$
\overline{X} = \frac{1}{N}\sum_{i=1}^{N}x_i
$$

随着随机抽象数目N的增大，估计的方差逐渐减小。当N无限大时，随机变量的统计平均值趋近于期望的值。
$$
E[X] \approx \overline{X} = \frac{1}{N}\sum_{i=1}^{N}x_i
$$

大数定律是蒙特卡洛方法的基础，用随机抽样和统计试验求出近似解。
#### 蒙特卡洛积分
$f(x)$服从概率密度函数$p(x)$，对下面的积分，有：
$$
I = \int_{a}^{b}f(x)dx = \int_{a}^{b}\frac{f(x)}{p(x)}p(x)dx = E[\frac{f(x)}{p(x)}]
$$

随意上述问题转化为了求$\frac{f(x)}{p(x)}$的期望。根据大数定律，可得估计值。

$$
I =  E[\frac{f(x)}{p(x)}] \approx\frac{1}{N}\sum_{i=1}^{N}\frac{f(x_i)}{p(x_i)}
$$

在实时渲染中，PBR的积分方程主要由这种估计思想来求解。
### Split Sum Approximation
蒙特卡洛积分
$$
\int\limits_H L_i(p,l) f(l, v) cos \theta_l dl \approx \frac{1}{N} \sum_{k=1}^{N} \frac{L_i(l_k) f(l_k, v) cos \theta_{l_k}}{p(l_k, v)}
$$
其中$p(l_k, v)$是概率密度函数pdf。pdf是一个在半球内积分为1的归一化函数。
$$
\frac{1}{N} \sum_{k=1}^{N} \frac{L_i(l_k) f(l_k, v) cos \theta_{l_k}}{p(l_k, v)} \approx (\frac{1}{N} \sum_{k=1}^{N} L_i(l_k) )(\frac{1}{N} \sum_{k=1}^{N} \frac{f(l_k, v) cos \theta_{l_k}}{p(l_k, v)} )
$$
### diffuse
$$
\frac{1}{N} \sum_{k=1}^{N} L_i(l_k) 
$$
PreFilter EnvionmentMap
以粗糙度为参数生成MIP。
### specular
$$
\frac{1}{N} \sum_{k=1}^{N} \frac{f(l_k, v) cos \theta_{l_k}}{p(l_k, v)} = \int\limits_H f(l, v) cos \theta_l dl
$$
$$
\int\limits_H f(l, v) cos \theta_l dl = F_0 \int\limits_H \frac {f(l, v)}{F(v,h)}(1 - (1 - v \cdot h)^5) cos \theta_l dl + \int\limits_H \frac {f(l, v)}{F(v,h)} (1 - v \cdot h)^5 cos \theta_l dl
$$

$$
\int\limits_H f(l, v) cos \theta_l dl = F_0 \cdot EnvBRDF.x + EnvBRDF.y
$$
### IBL
``` HLSL
float3 ApproximateSpecularIBL(float3 SpecularColor, float Roughness, float3 N, float3 V)
{
    float NoV = saturate(dot(N, V));
    float3 R = 2 * dot(V, N) * N - V;
    float3 PrefilteredColor = PrefilterEnvMap(Roughness, R);
    float2 EnvBRDF = IntegrateBRDF(Roughness, NoV);
    return PrefilteredColor * (SpecularColor * EnvBRDF.x + EnvBRDF.y);
}
```

### 预留
F表示累计分布函数，cdf，P([a,b])表示随机变量X落在[a, b]的概率。
$$
F\{a \leqslant  x \leqslant  b\} = \int_{a}^{b}p(x)dx
$$

### 引用
1. https://learnopengl.com/PBR/IBL/Diffuse-irradiance
2. https://learnopengl.com/PBR/IBL/Specular-IBL
3. http://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/monte-carlo-methods-in-practice/monte-carlo-integration
4. https://blog.csdn.net/baimafujinji/article/details/53869358
5. http://www.codinglabs.net/article_physically_based_rendering_cook_torrance.aspx
6. https://www.zhihu.com/search?type=content&q=%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B%E7%A7%AF%E5%88%86
