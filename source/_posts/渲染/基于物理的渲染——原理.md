---
title: 基于物理的渲染——原理
categories: 渲染
mathjax: true
---
物理的渲染（Physically Basic Rendering），简称PBR，是一种相对遵循现实世界的物理规律的渲染方式。相对于之前使用的Blinn-Phone光照模型，PBR看起来更加真实。美术设计师可以根据物理参数来制作材质，使材质在不同的环境下都保持一致的物理表现，而不是像以前那样需要以经验调节一个较好的效果，当换了一个环境之后，很容易表现不出制作时想要表达的材质。

先回顾一下传统光照模型，然后引入PBR光照模型。
### 一、传统光照模型
#### Lambert光照模型
$$
I_{Lambert} = k_a I_a + k_d (n \cdot l)I_d
$$
其中下标$a$表示环境光（Ambient Light）,下表$d$表示漫反射光，$k$表示对应项的系数，$n$表示表面法线，$l$表示看向光的方向。
Lambert模型没有高光部分，无法表现很好地表现反射效果。
#### Phong光照模型
$$
I_{Phong} = k_a I_a + k_d (n \cdot l)I_d + k_s (r \cdot v)^{\alpha } I_s
$$
其中$I$表示高光的颜色或者，亮度α 模拟表面粗糙程度，值越小越粗糙，越大越光滑。
$r$入射向量$l$根据法线$n$得到的反射向量。

$$
r = 2 (n \cdot l) n - l
$$
Phong光照模型相比Lambert模型增加了高光部分。

#### Blinn-Phong
$$
I_{Blinn-Phong} = k_a I_a + k_d (n \cdot l)I_d + k_s (n \cdot h)^{\alpha } I_s
$$
其中$h$是$l$和$v$的中间向量：
```math
h = \frac{l + v}{||l + v||}
```
相比Phong模型而言，Blinn-Phong模型在观察方向趋向平行于表面时，高光形状会拉长，更接近真实情况，并且效率比Phong模型要高一些，被广泛应用。

#### 传统光照模型的缺陷
对金属来说，折射的光线会被金属内部完全吸收掉，diffuse部分很暗，金属的颜色来自于specular。而非金属折射的光线部分经过散射后会返回表面，形成diffuse，再加上specular，形成非金属的颜色。
由于没有传统光照模型没有考虑到这个性质，所以做出来的材质会有浓浓的塑料感。
还有非常重要的能量守恒没有考虑，当传统材质换个环境（贴图），表现的材质与最初做的材质很可能就不一样了。

而基于物理的渲染，能够解决这些问题。随着硬件的发展，PBR已经完全能够应用到移动端的实时渲染了。

### 二、基于物理的渲染
我们从先介绍一下PBR需要的物理和光学的概念。
#### 几何光学模型
#### 光与平面的交互
光照射物体表面时，会发射折射和反射。
除了镜子、镜头外的大多数物体的表面都不是完美平坦的。
微面元理论假设物质表面由大量微观结构的光滑面元组成，这些微观结构远小于一个像素的尺寸，光束与每个面元进行交互时，被折射或反射至不同的方向。

这些微面元法线（microfacet normals）的方向的分布用一个统计的法线分布函数给出（NDF）。
它反映的是光从每个反向反射的概率，如大多数表面的NDF函数集中在表面的宏观法线上。

面元都是光滑的，所以光的反射方向与观察方向相同的才能被看到。也就是说，面元的法线正好在入射方向和观察方向v的中 间。

对法线方向是h的面元，可能会在光源方向和观察方向被其他面元遮挡，用**G**来表示几何遮挡关系。

我们使用roughness粗糙度来表示表面的粗糙程度，越大的时候表面法线的变化越广泛，越粗糙，会出现模糊的反射；值越小 表面法线的变化越轻微，出现较为清晰的反射。

反射的光叫镜面反射光specular，折射后的内部散射并且重新返回到平面折射到严重的光叫漫反射光。
#### 金属和非金属
折射光在物体内部的表现取决于物体的构成，在渲染领域一般分为金属和非金属。金属会吸收所有的折射光，反射率要比非金属药膏。金属的反射率通常在0.6-0.9，非金属一般是0-0.2.反射率高就阻止了入射光被折射，所以金属看着亮一些。
用metalness金属度来区分物体金属的程度，1.0是纯金属，0是非金属。之间的部分表示腐蚀的金属等。

#### 能量守恒
漫反射与镜面反射的光的能量小于等于入射光的能量。
漫反射较多而且粗糙的材质，会反射模糊和更广阔的高光，比较光滑而反射率高的材质则反射更明亮和紧凑的高光

```math
L=C_{diff}N\cdot L+C_{spec}(N\cdot H)^{m}
```

```math
 L=C_{diff}cos\theta_{l}+C_{spec}cos^{m}\theta_{h}
```

基于物理的渲染具有以下性质：
- 能量守恒，反射光能量小于等于入射光
- 菲涅尔效果
- 区别金属和电介质
- 微平面理论
- 线性空间计算光照

可以带给我们以下好处：
- 基于物理世界的真实参数，参数少，便于理解
- 金属工作流，方便美术制作，不用依靠经验调参数
- 渲染效果更加真实
- 同样的材质能够在不同的环境下表现如下雨天，黄昏等

#### 光与物质的交互
内部均匀的介质，如透明的均匀介质水、玻璃等，折射率唯一，光通过时不会改变强度或颜色。而当介质对某一种可见光有吸收率的时候，光会在介质的传播过程被吸收，光的方向不变，颜色变化或强度减弱。

光在非均匀介质中传播时会发生散射现象，光会被分割为多个方向，但光的总量不变。

物质还可能因为自身能量发出新的光，叫自发光。
