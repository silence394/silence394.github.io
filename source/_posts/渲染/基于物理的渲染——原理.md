---
title: 基于物理的渲染——理论基础
categories: 渲染
mathjax: true
---
物理的渲染（Physically Basic Rendering），简称PBR，是一种相对遵循现实世界的物理规律的渲染方式。相对与传统光照模型Blinn-Phong光照模型，PBR看起来更加真实。美术设计师可以根据物理参数来制作材质，使材质在不同的环境下都保持一致的物理表现，而不是像以前以经验调节一个较好的效果，当换了一个环境之后，很容易表现不出制作时想要表达的材质。

先回顾一下传统光照模型，然后引入PBR光照模型。
<!-- more --> 
### 一、传统光照模型
#### Lambert光照模型
$$
I_{Lambert} = k_a I_a + k_d (n \cdot l)I_d
$$
其中下标$a$表示环境光（Ambient Light）,下表$d$表示漫反射光，$k$表示对应项的系数，$n$表示表面法线，$l$表示看向光的方向。
Lambert模型没有高光部分，无法表现很好地表现反射效果。
#### Phong光照模型
$$
I_{Phong} = k_a I_a + k_d (n \cdot l)I_d + k_s (r \cdot v)^{\alpha } I_s
$$
其中$I$表示高光的颜色或者，亮度α 模拟表面粗糙程度，值越小越粗糙，越大越光滑。
$r$入射向量$l$根据法线$n$得到的反射向量。

$$
r = 2 (n \cdot l) n - l
$$
Phong光照模型相比Lambert模型增加了高光部分。

#### Blinn-Phong
$$
I_{Blinn-Phong} = k_a I_a + k_d (n \cdot l)I_d + k_s (n \cdot h)^{\alpha } I_s
$$
其中$h$是$l$和$v$的中间向量：
```math
h = \frac{l + v}{||l + v||}
```
相比Phong模型而言，Blinn-Phong模型在观察方向趋向平行于表面时，高光形状会拉长，更接近真实情况，并且效率比Phong模型要高一些，被广泛应用。

#### 传统光照模型的缺陷
对金属来说，折射的光线会被金属内部完全吸收掉，diffuse部分很暗，金属的颜色来自于specular。而非金属折射的光线部分经过散射后会返回表面，形成diffuse，再加上specular，形成非金属的颜色。由于没有传统光照模型没有考虑到这个性质，所以做出来的材质会有浓浓的塑料感。

还有非常重要的能量守恒没有考虑，当传统材质换个环境（贴图），表现的材质与最初做的材质很可能就不一样了。

而基于物理的渲染，能够解决这些问题。随着硬件的发展，PBR已经完全能够应用到移动端的实时渲染了。

### 二、物体的表面着色
了解基于物理的渲染之前需要了解光与物体表面的交互，再结合光学测量知识，才能真正地通向基于物理的渲染。
#### 几何光学模型
几何光学模型是被计算机图形学广泛采用的模型，并做了一些简化的假设，虽然限制了一些效果如衍射，但是使它处理起来相对简单，并且满足图形学一般的需求。这些假设包括：
- 物体的表面是绝对光滑的。
- 光可以被发射、反射、折射和传播。
- 光以无限快的速度沿直线传播。

在几何光学模型中，平面两侧有各自的折射率，反射定律和斯涅尔定律决定光的反射和折射。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fye3utqwqzj20fu0a1mx6.jpg)

#### 光与表面的交互
自然界中的物体除了镜子、镜头外的绝大多数物体的表面都不是光学平坦的。

在微观尺度上，表面是不光滑的，光照向每个比像素更小的点时，可能沿不同的方向反射或折射。这导致对于一个像素点，每条入射光会被反射或折射至多个方向。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fye4j8fo6rj20ez07tmxb.jpg)

##### 金属和非金属
上面讨论了光与物体表面的交互，对于折射进物体内部的光线会发射什么呢？这取决于物体材质的结构。计算机图形学中，材质主要分为金属和非金属。

对于金属，会吸收所有折射的光线。
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fye53c56cvj20fc06n3yh.jpg)

对于非金属，如果该物体是均匀透明的，如玻璃和水晶，则折射光会在物体内部沿直线传播，直到遇到物体的表面后折射离开物体表面。对于非透明的物体，由于内部介质的不连续，折射的光会沿着不同的方向继续反射或折射。部分光会回到物体表面，部分光可能被吸收。
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fye53c3b4yj20f606kweq.jpg)

计算机图形学中通常将发射和漫反射两种不同的光照区分开：为高光（specular）和漫反射光（diffuse）。高光主要是光在物体表面直接反射形成，漫反射通常由光进入物体表面，经历折射、吸收、散射过程之后重新回到表面的光形成。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyep3s2yuoj20jr09udjn.jpg)

##### 粗糙度
对于高光部分，反射光所处的范围取决于表面的粗糙度。表面越粗糙，微观尺度的表面朝向差别越大，反射光线的方向差别也就越大，反射的范围越大，反射的图像也就越模糊。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fye4pd1ymej20k00ce3z5.jpg)

微面元理论假设物质表面由大量微观结构的光滑面元组成，这些微观结构远小于一个像素的尺寸，光束与每个面元进行交互时，被折射或反射至不同的方向。

##### 能量守恒
能量守恒在基于物理渲染的渲染中非常重要。它表示漫反射与镜面反射的光的能量小于等于入射光的能量。在传统光照模型中，美术无法控制能量守恒，而在PBR中是一个基本的保证。所以PBR做出来的材质更加真实。

##### 菲涅尔（Fresnel）效果
在真实世界，除了金属之外，其他物质都用于不同的“菲涅尔效果”。视线垂直于表面时，反射较弱，而当视线非垂直表面时，夹角越小，反射越明显。如果你看向一个圆球，那圆球中心的反射较弱，靠近边缘较强。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyepy4wzt7j207406t749.jpg)

清水有着非常明显的菲涅尔效果：从水面上往下看，我们能够很清楚地看到池底。而从接近平行于水面的方向看，我们看到的高光很明显，几乎看不到池底。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyeqd0sfzwj20lw0el0ww.jpg)

### 三、辐射度量学
将光的测量即辐射度量学引入到计算机图形学中，用于测量和计算图形学中光的传播，并由此推导出渲染方程。

#### 辐射能量
辐射能量是以辐射的形式发射、传播或接受的能量，表示为**Q**，单位为**J**（焦耳）.
#### 辐射通量
辐射通量指单位时间内通过表面或者空间区域的能量，用**Φ**表示，单位为**W**（瓦特）。
$$
\Phi =\frac{dQ}{dt}
$$
#### 辐射照度（Irrdiance）
辐照度，用符号**E**表示，表示单位时间内到达单位面积的辐射能量，单位是$W/m^2$。
$$
E=\frac{dΦ}{dA}
$$
在处理辐照度时，需要处理表面朝向和光线方向的角度。光线与接收光照的表面的法线夹角增大（更加倾斜），表面能接收到的辐照度会降低。假设垂直于光线的表面接受的辐照度为$E_L$，那么任意表面接受的辐照度为$E = E_L\cos\theta$，其中θ为表面法线与光线反向的夹角。
$$
dE_L = \frac{dΦ}{dAcos\theta}
$$

点光源向四周辐射能量，可以看成以电光源为中心不同半径的球包围着点光源。穿过这些球的辐射通量是相同的，都是**Φ**，球的表面积为$4πr^2$，通量密度$E = \frac{Φ}{4πr^2}$，也就是说辐照度与距离的平方成反比。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fygg8qgzb5j20k00a6t8x.jpg)
#### 立体角（solid angle）
在讲辐射强度之前，需要引入立体角的概念。

在几何学中，立体角是2D角度的概念在3D空间的延伸。2D空间中，用单位圆上的一段弧线的长度表示其对应角度的大小。在3D空间中，立体角表示从单位球体的原点观察到的球的表面积。立体角用**Ω**表示，单位为**sr**（球面度steradian的缩写）。
$$
d\omega =\frac{dA}{r^{2}}
$$
**dA**为面积微元，在球坐标系下可以写成：
$$
dA=(rd\theta )(rsin\theta d\varphi )=r^{2}sin\theta d\theta d\varphi 
$$
推导出面积微元的长和宽相乘即可。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyfakqht3cj209c08gq2y.jpg)
#### 辐射强度（Radiant Itensity）
辐射照度的测量与距离光源的距离相关，有时我们需要一个不随光源距离变化的测量数据，引入了辐射强度。它表示通过单位立体角的辐射通量。用符号**I**表示，单位为$W/sr$。
$$
I = \frac{dΦ}{d\omega}
$$
#### 辐射率（辐射亮度，Radiance）
辐射率表示的是从一个微小面积出发，射向某个微小方向的辐射通量（或来自某个微小方向，照射到微小面积的通量）。用符号**L**表示，指单位投影面积单位立体角的辐射通量，单位为$W/(m^2sr)$。
$$
L=\frac{d^{2}\Phi }{dAcos\theta d\omega }
$$
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyghhkc1oaj209q08fdga.jpg)
辐射率和辐射照度的关系可以推导如下，
$$
L = \frac{d^2\Phi}{d\omega*dA*cos\theta}=\frac{dE_L}{d\omega cos\theta}\Rightarrow dE_L=Lcos\theta d\omega
$$

### 四、渲染方程
在光照计算中我们感兴趣的是辐射率$L$，它能表示物体在某一点的亮度。在一个特定点$x$和朝向观察者的方向$ω_o$，出射光$L_o$是自发光$L_e$和反射光$L_r$之和：
$$
L_o(x, w_o) = L_e(x, ω_o) + L_r(ω_o)
$$
大部分物体都没有自发光，所以我们只需关心反射部分$L_r$。下面对$L_r$进行拆解。
#### 双向反射分布函数（BRDF）
双向反射分布函数（Bidrectionla Reflectance Distribution Function，简称BRDF），描述了光如何在表面进行反射。通俗来说：当沿$ω_i$方向的入射的辐射率为$L_i(ω_i)$时，计算有多少辐射率朝向观察者的方向$ω_o$离开表面，记为$L_o(ω_o)$。

那么在表面入射的微分辐照度为$dE(ω_i) = L_i(ω_i)\cos\theta_idω_i$，反射的微分辐射率$dL_o(ω_o)$，二者的比值定义了BRDF函数。
$$
f_r(\omega_o,\omega_i)=\frac{dL_o(\omega_o)}{dE_i(\omega_i)}=\frac{dL_o(\omega_o)}{L_i(\omega_i)cos\theta_id\omega_i}
$$
计算出射方向的辐射率，可以对法线方向半球进行积分：
$$
L_o(x, w_o) = L_r(ω_o) = \int_{\Omega }f_r(\omega_o, \omega_i)\otimes L_i(\omega_i)\cos\theta_id\omega_i
$$
对于点光源、平行光等方向光源，由于表面的某个点只会被来自一个方向的光线照射到，出射的辐射率可以表示为：
$$
L_o(x, w_o) = f_r(\omega_o, \omega_i)\otimes L_i(\omega_i)\cos\theta_i
$$
对多个方向光源，出射点的辐射率简单累加即可。
$$
L_o(x, w_o) =\sum_{k=1}^{n} f_r(\omega_o, \omega_{ik})\otimes L_{ik}(\omega_ik{})\cos\theta_{ik}
$$
下面介绍建立BRDF模型需要引入的微平面理论。
#### 微平面理论（Microfacet Theory）
在前面提过，微观尺度上绝大多数物体的表面都不是光滑的。所以提出了微面元理论来模拟这种微观结构的分布。它假设物体是由大量微观集合结构的微面元组成，每个面元是绝对光滑的，因此光与面元的交互遵循反射和折射定律。
##### 法线分布函数（Normal Distribution Function）
微面元法线方向的分布用了一个统计的法线分布函数（简称NDF）给出，这个分布函数反映光从每个方向反射的概率。对于微面元，光的反射方向恰好在观察方向的光线才能被看到。所以只有那些微面元满足法线是光线方向$l$和观察方向$v$的中间向量，即半矢量$h = \frac{l+v}{|l + v|}$，才能被我们看到。NDF记为$D(h)$。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyhkta6xr4j20k0064weq.jpg)
##### 几何遮挡函数（Geometrical Shadowing)
并不是所有法线在半矢量$h$方向的面元都会被看到，其中的一些会在光源方向或者观察方向上被其他面元阻挡。尽管还有一些被阻挡的光线可能经过多次反射后重新进入观察实现，但是一般会忽略这种复杂的情况情况。所以提出了几何衰减因子表示光线未被遮挡，能从$l$方向反射到$v$方向的概率，记为$G(l, v, h)$。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyhl0x68n5j215709umyn.jpg)
上图的三种情况分别表示入射光线被遮挡（Shadowing），反射光线被遮挡（Masking），光线被多次反射（Interreflection）。
##### 菲涅尔方程
光线一部分被反射，一部分被折射，菲涅尔方程描述的是被反射的光线对比被折射的光线的比率。而之前提过的根据视线的不同，表面的反射率也不同，也就是菲涅尔效应。这部分也被综合到菲涅尔方程中。
所以当光线到达表面时，菲涅尔方程会根据观察角度告诉我们被反射的光线所占的百分比，记为$F(v, h)$。

#### PBR渲染方程
光在物体表面的反射具有具有漫反射和镜面反射两个部分，结合微平面理论，在UE4的着色模型中BRDF中，漫反射部分采用了Labertian模型，镜面反射部分采用了Cook Torrance模型。由于符号$l$与$ω_i$同义，$v$与$ω_o$等价，统一符号，渲染方程可以写成：
$$
L_o = = \int_{\Omega }f_r(\omega_i, \omega_o)\otimes L_i(\omega_i)\cos\theta_id\omega_i =\int_{\Omega }(f_{lambert} + f_{cook-tarrance})\otimes L_i(\omega_i)\cos\theta_id\omega_i
$$
其中
$$f_{lambert}(\omega_i, \omega_o) = \frac{c_{diff}}{π} $$
$$f_{cook-tarrance}(\omega_i, \omega_o, h) = \frac{D(h)G(\omega_i, \omega_o,h)F(\omega_o,h)}{4(n\cdot \omega_i)(n\cdot \omega_o)}
$$

### 五、总结
本文里列出了传统光照模型的局限性，并介绍了能解决这些缺陷的PBR所需要的理论知识，给出渲染方程。后续的两篇文章会实现PBR材质，包含直接光照和间接光照。

### 参考
1. https://blog.selfshadow.com/publications/s2013-shading-course/hoffman/s2013_pbs_physics_math_notes.pdf
2. https://zhuanlan.zhihu.com/p/21376124
3. https://zhuanlan.zhihu.com/p/28059221
4. https://learnopengl-cn.github.io/07%20PBR/01%20Theory/
5. http://www.thegibook.com/

