---
title: 基于物理的渲染——原理
categories: 渲染
mathjax: true
---
物理的渲染（Physically Basic Rendering），简称PBR，是一种相对遵循现实世界的物理规律的渲染方式。相对于之前使用的Blinn-Phong光照模型，PBR看起来更加真实。美术设计师可以根据物理参数来制作材质，使材质在不同的环境下都保持一致的物理表现，而不是像以前需要以经验调节一个较好的效果，当换了一个环境之后，很容易表现不出制作时想要表达的材质。

先回顾一下传统光照模型，然后引入PBR光照模型。
### 一、传统光照模型
#### Lambert光照模型
$$
I_{Lambert} = k_a I_a + k_d (n \cdot l)I_d
$$
其中下标$a$表示环境光（Ambient Light）,下表$d$表示漫反射光，$k$表示对应项的系数，$n$表示表面法线，$l$表示看向光的方向。
Lambert模型没有高光部分，无法表现很好地表现反射效果。
#### Phong光照模型
$$
I_{Phong} = k_a I_a + k_d (n \cdot l)I_d + k_s (r \cdot v)^{\alpha } I_s
$$
其中$I$表示高光的颜色或者，亮度α 模拟表面粗糙程度，值越小越粗糙，越大越光滑。
$r$入射向量$l$根据法线$n$得到的反射向量。

$$
r = 2 (n \cdot l) n - l
$$
Phong光照模型相比Lambert模型增加了高光部分。

#### Blinn-Phong
$$
I_{Blinn-Phong} = k_a I_a + k_d (n \cdot l)I_d + k_s (n \cdot h)^{\alpha } I_s
$$
其中$h$是$l$和$v$的中间向量：
```math
h = \frac{l + v}{||l + v||}
```
相比Phong模型而言，Blinn-Phong模型在观察方向趋向平行于表面时，高光形状会拉长，更接近真实情况，并且效率比Phong模型要高一些，被广泛应用。

#### 传统光照模型的缺陷
对金属来说，折射的光线会被金属内部完全吸收掉，diffuse部分很暗，金属的颜色来自于specular。而非金属折射的光线部分经过散射后会返回表面，形成diffuse，再加上specular，形成非金属的颜色。
由于没有传统光照模型没有考虑到这个性质，所以做出来的材质会有浓浓的塑料感。
还有非常重要的能量守恒没有考虑，当传统材质换个环境（贴图），表现的材质与最初做的材质很可能就不一样了。

而基于物理的渲染，能够解决这些问题。随着硬件的发展，PBR已经完全能够应用到移动端的实时渲染了。

### 二、物体的表面着色
了解基于物理的渲染之前需要了解光与物体表面的交互，再结合光学测量知识，才能真正地通向基于物理的渲染。
#### 几何光学模型
几何光学模型是被计算机图形学广泛采用的模型，并做了一些简化的假设，虽然限制了一些效果如衍射，但是使它处理起来相对简单，并且满足图形学一般的需求。这些假设包括：
- 物体的表面是绝对光滑的。
- 光可以被发射、反射、折射和传播。
- 光以无限快的速度沿直线传播。

在几何光学模型中，平面两侧有各自的折射率，反射定律和斯涅尔定律决定光的反射和折射。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fye3utqwqzj20fu0a1mx6.jpg)

#### 光与表面的交互
自然界中的物体除了镜子、镜头外的绝大多数物体的表面都不是光学平坦的。

在微观尺度上，表面是不光滑的，光照向每个比像素更小的点时，可能沿不同的方向反射或折射。这导致对于一个像素点，每条入射光会被反射或折射至多个方向。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fye4j8fo6rj20ez07tmxb.jpg)

##### 金属和非金属
上面讨论了光与物体表面的交互，对于折射进物体内部的光线会发射什么呢？这取决于物体材质的结构。计算机图形学中，材质主要分为金属和非金属。

对于金属，会吸收所有折射的光线。
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fye53c56cvj20fc06n3yh.jpg)

对于非金属，如果该物体是均匀透明的，如玻璃和水晶，则折射光会在物体内部沿直线传播，直到遇到物体的表面后折射离开物体表面。对于非透明的物体，由于内部介质的不连续，折射的光会沿着不同的方向继续反射或折射。部分光会回到物体表面，部分光可能被吸收。
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fye53c3b4yj20f606kweq.jpg)

计算机图形学中通常将发射和漫反射两种不同的光照区分开，成为高光（specular）和漫反射光（diffuse）。高光主要是光在物体表面直接反射形成，漫反射通常由光进入物体表面，经历折射、吸收、散射过程之后重新回到表面的光形成。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyep3s2yuoj20jr09udjn.jpg)

##### 粗糙度
对于高光部分，反射光所处的范围取决于表面的粗糙度。表面越粗糙，微观尺度的表面朝向差别越大，反射光线的方向差别也就越大，反射的范围越大，反射的图像也就越模糊。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fye4pd1ymej20k00ce3z5.jpg)

微面元理论假设物质表面由大量微观结构的光滑面元组成，这些微观结构远小于一个像素的尺寸，光束与每个面元进行交互时，被折射或反射至不同的方向。

##### 能量守恒
能量守恒在基于物理渲染的渲染中非常重要。它表示漫反射与镜面反射的光的能量小于等于入射光的能量。在传统光照模型中，美术无法控制能量守恒，而在PBR中是一个基本的保证。所以PBR做出来的材质更加真实。

##### 菲涅尔（Fresnel）效果
在真实世界，除了金属之外，其他物质都用于不同的“菲涅尔效果”。视线垂直于表面时，反射较弱，而当视线非垂直表面时，夹角越小，反射越明显。如果你看向一个圆球，那圆球中心的反射较弱，靠近边缘较强。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyepy4wzt7j207406t749.jpg)

清水有着非常明显的菲涅尔效果：从水面上往下看，我们能够很清楚地看到池底。而从接近平行于水面的方向看，我们看到的高光很明显，几乎看不到池底。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyeqd0sfzwj20lw0el0ww.jpg)

### 三、辐射度量学
将光的测量即辐射度量学引入到计算机图形学中，用于测量和计算图形学中光的传播，并由此推导出渲染方程。

#### 辐射能量
辐射能量是以辐射的形式发射、传播或接受的能量，表示为**Q**，单位为**J**（焦耳）.
#### 辐射通量
辐射通量指单位时间内通过表面或者空间区域的能量，用**Φ**表示，单位为**W**（瓦特）。
$$
\Phi =\frac{dQ}{dt}
$$
#### 立体角（solid angle）
在几何学中，立体角是2D角度的概念在3D空间的延伸。2D空间中，用单位圆上的一段弧线的长度表示其对应角度的大小。在3D空间中，立体角表示从单位球体的原点观察到的球的表面积。立体角用**Ω**表示，单位为**sr**（球面度steradian的缩写）。
$$
d\omega =\frac{dA}{r^{2}}
$$
**dA**为面积微元，在球坐标系下可以写成：
$$
dA=(rd\theta )(rsin\theta d\varphi )=r^{2}sin\theta d\theta d\varphi 
$$
推导出面积微元的长和宽相乘即可。
![](http://ww1.sinaimg.cn/mw690/c5c3a364ly1fyfakqht3cj209c08gq2y.jpg)
#### 辐射亮度
#### 辐射强度

```math
L=C_{diff}N\cdot L+C_{spec}(N\cdot H)^{m}
```

```math
 L=C_{diff}cos\theta_{l}+C_{spec}cos^{m}\theta_{h}
```

基于物理的渲染具有以下性质：
- 能量守恒，反射光能量小于等于入射光
- 菲涅尔效果
- 区别金属和电介质
- 微平面理论
- 线性空间计算光照

可以带给我们以下好处：
- 基于物理世界的真实参数，参数少，便于理解
- 金属工作流，方便美术制作，不用依靠经验调参数
- 渲染效果更加真实
- 同样的材质能够在不同的环境下表现如下雨天，黄昏等

#### 光与物质的交互
内部均匀的介质，如透明的均匀介质水、玻璃等，折射率唯一，光通过时不会改变强度或颜色。而当介质对某一种可见光有吸收率的时候，光会在介质的传播过程被吸收，光的方向不变，颜色变化或强度减弱。

光在非均匀介质中传播时会发生散射现象，光会被分割为多个方向，但光的总量不变。

物质还可能因为自身能量发出新的光，叫自发光。

这些微面元法线（microfacet normals）的方向的分布用一个统计的法线分布函数给出（NDF）。
它反映的是光从每个反向反射的概率，如大多数表面的NDF函数集中在表面的宏观法线上。

面元都是光滑的，所以光的反射方向与观察方向相同的才能被看到。也就是说，面元的法线正好在入射方向和观察方向v的中 间。

对法线方向是h的面元，可能会在光源方向和观察方向被其他面元遮挡，用**G**来表示几何遮挡关系。

我们使用roughness粗糙度来表示表面的粗糙程度，越大的时候表面法线的变化越广泛，越粗糙，会出现模糊的反射；值越小 表面法线的变化越轻微，出现较为清晰的反射。

反射的光叫镜面反射光specular，折射后的内部散射并且重新返回到平面折射到严重的光叫漫反射光。

折射光在物体内部的表现取决于物体的构成，在渲染领域一般分为金属和非金属。金属会吸收所有的折射光，反射率要比非金属药膏。金属的反射率通常在0.6-0.9，非金属一般是0-0.2.反射率高就阻止了入射光被折射，所以金属看着亮一些。
用metalness金属度来区分物体金属的程度，1.0是纯金属，0是非金属。之间的部分表示腐蚀的金属等。

#### 线性空间渲染
美术设计师一般都在sRGB非线性空间下制图，而自然界的光照是线性的运算，所以我们需要把颜色贴图的空间转换到线性空间下，再进行光照运算，才能保证运算结果是符合物理规律的。
详见。