---
title: 渲染管线的基础数学
categories: 渲染
mathjax: true
---
此篇文章总结一下3D渲染用到的基础数学变换，对渲染管线有一个更清晰的认识。假设读者已经对渲染管线有了一个大致的认知，不会花太多篇幅将渲染关系各个阶段的作用。
### 渲染管线
渲染管线是经过一系列的数学变换，将3D空间中的点，变换到屏幕空间，并进行着色的过程。
包含的流程如下：
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fvgdkh0yf0j20l806rq2v.jpg)
如下图，顶点经过从世界空间变换到投影空间，投影空间下的顶点经过透视除法转换为标准设备空间坐标，再变换到视口下的坐标，将顶点组织成图元，光栅化着色并显示。
![image](https://i.loli.net/2018/09/13/5b9a7ab5a36b9.png)
![IMAGE](https://i.loli.net/2018/09/13/5b9a7ceaa9510.png)

这一系列变换实际上是对点和向量的数学运算，在3D渲染中采用了矩阵用于点和向量的变换。

### 矩阵
#### 矩阵的引入
先介绍一下为什么矩阵可以表示变换。在这边文章中我们以行向量进行矩阵的排布，矩阵的每一行都能解释为变换后的基向量，后面的矩阵全部在左手坐标系，并且基于行向量。

考虑一个向量**V**
$$
V = \begin{bmatrix}
x & y & z 
\end{bmatrix}
= \begin{bmatrix}
x & 0 & 0 
\end{bmatrix}
+
\begin{bmatrix}
0 & y & 0 
\end{bmatrix}
+
\begin{bmatrix}
0 & 0 & z 
\end{bmatrix}
= x\begin{bmatrix}
1 & 0 & 0 
\end{bmatrix}
+
y\begin{bmatrix}
0 & 1 & 0 
\end{bmatrix}
+
z\begin{bmatrix}
0 & 0 & 1 
\end{bmatrix}
$$
也就是向量**V**可以表示为+x, +y, +z轴的单位向量的变换组合。

假设**p**,**q**,**r**分别对应+x,+y,+z轴的单位向量，那么向量**V**就可以表示成**p**,**q**,**r**的线性变换，**p**,**q**,**r**即为基向量。
$$
V = x\mathbf{p} + y\mathbf{q} + z\mathbf{r}
= \begin{bmatrix}
x & y & z 
\end{bmatrix}
\begin{bmatrix}
\mathbf{p} \\ 
\mathbf{q}\\ 
\mathbf{z}
\end{bmatrix}
= \begin{bmatrix}
x & y & z 
\end{bmatrix}
\begin{bmatrix}
p_x & p_y & p_z\\ 
q_x & q_y & q_z\\ 
r_x & r_y & r_z
\end{bmatrix}
$$
那么我们可以定义矩阵**M**，将向量(x, y , z)变换到**V**，即**M**为从(x, y, z)到**V**的变换矩阵。
$$
\boldsymbol{M} = \begin{bmatrix}
p_x & p_y & p_z\\ 
q_x & q_y & q_z\\ 
r_x & r_y & r_z
\end{bmatrix}
$$
如果感觉比较难以理解，这个视频[Transmations](https://www.youtube.com/watch?v=kYB8IZa5AuE&feature=youtu.be&list=PLZHQObOWTQDPD3MizzM2xVFitgF8hE_ab&t=193)或OpenGL的[变换](https://learnopengl-cn.github.io/01%20Getting%20started/07%20Transformations/)可以让你对矩阵表示线性变换有个直观的感受。
#### 旋转和缩放矩阵
考虑一个矩阵2x2的矩阵**M**
$$
M = \begin{bmatrix}
1 & 1\\ 
-1 & 1 \\ 
\end{bmatrix}
$$
从这个矩阵中抽取变换后的基向量**p** = [1 1], **q** = [-1 1]，假设原基向量是(1, 0), (-1, 0)，那么矩阵M表示了对向量缩放$\sqrt{1^2 + 1^2} = \sqrt{1^2 + -1^2} = \sqrt{2}$，然后逆时针旋转$45^{\circ}$。

想要缩放某个向量，只需要将向量的各个分量，分别乘以各个轴的缩放因子。如向量**p**(x, y, z)分别乘以各个轴的缩放$s_x$, $s_y$, $s_z$，得$p\mathbf{'}$，

$$
p' =\begin{bmatrix}
 p_x * s_x & p_y * s_y  &  p_z * s_z
\end{bmatrix}
= p
\begin{bmatrix}
s_x & 0 & 0 \\ 
0 & s_y & 0 \\ 
0 & 0 & s_z
\end{bmatrix}
$$

所以缩放矩阵为:
$$
M = \begin{bmatrix}
s_x & 0 & 0 \\ 
0 & s_y & 0 \\ 
0 & 0 & s_z
\end{bmatrix}
$$

接下来看旋转矩阵，先在2D坐标系里看向量的旋转。在XOY坐标系内任意一点**v**(x, y),其与x轴的夹角为α度，将其旋转β度，得到**v'**，此时**v'** 与x轴的夹角为(α+β)度。假设**v**的长度为**r**,用极坐标表示点，得$x = rcosα$，$y = r\sin \alpha$，$x' = r\cos \left ( \alpha + \beta \right )$，$y' = r\sin \left ( \alpha + \beta \right )$，那么根据三角函数可得，
$x' = r\left ( \cos \alpha \cos \beta  - \sin \alpha \sin \beta  \right ) = 
\begin{bmatrix}
r\cos \alpha & r\sin \alpha
\end{bmatrix} \begin{bmatrix}
\cos \beta\\
-\sin \beta \\ 
\end{bmatrix}$
$y' = r\left ( \cos \alpha \sin \beta  + \sin \alpha \cos \beta  \right ) = 
\begin{bmatrix}
r\cos \alpha & r\sin \alpha
\end{bmatrix} \begin{bmatrix}
\sin\beta\\
\cos \beta \\ 
\end{bmatrix}$
可以得到旋转矩阵为
$$
M = \begin{bmatrix}
\cos \beta & \sin \beta\\ 
-\sin \beta & \cos \beta \\ 
\end{bmatrix}
$$

下面来看3D空间中绕各轴的旋转的旋转:
绕x轴旋转θ度，Y轴基向量(0, 1, 0)旋转的向量为(0, cosθ, sinθ)，Z轴基向量(0, 0, 1)旋转后的向量为(0, -sinθ, cosθ)
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fvgdcusiqsj20b4090adr.jpg)
得到绕X轴的旋转矩阵为：
$$
M_x(\theta) = \begin{bmatrix}
1 & 0 & 0 \\
0 &\cos \theta & \sin \theta  \\
0 & -\sin \theta & \cos \theta \\
\end{bmatrix}
$$

绕y轴的旋转与绕x轴的旋转类似：
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fvgde12kmhj20b308t42h.jpg)
得到绕Y轴的旋转矩阵为：
$$
M_y(\theta) = \begin{bmatrix}
\cos \theta & 0 & -\sin \theta \\
0 & 1 & 0  \\
\sin \theta & 0 & \cos \theta \\
\end{bmatrix}
$$

同理可得出，绕Z轴的旋转矩阵：
$$
M_z(\theta) = \begin{bmatrix}
\cos \theta & \sin \theta & 0 \\
-\sin \theta &\cos \alpha & 0  \\
0 & 0 & 1 \\
\end{bmatrix}
$$

#### 位移
在2D空间中对点进行位移，用公式可以表示为：
$x' = x + t_x$，$y' = y + t_y$
由于点与矩阵的运算是向量与矩阵的各个分量相乘，无法通过(x, y)与二维矩阵相乘得出常数项$t_x$, $t_y$。
位移的公式可以以下形式：
$x' = 1 * x + 0 * y + 1 * t_x$，
$y' = 0 * x + 1 * y + 1 * t_y$
即向量(x, y, 1)与矩阵$
\begin{bmatrix}
1 & 0\\ 
0 & 1 \\
tx & ty \\
\end{bmatrix}
$的乘积。也就是说，把2D点变为3D向量，2x2矩阵变为3x2矩阵就可以表示2D点的位移。
这实际上就是齐次坐标，简而言之就是用N+1维的坐标来表示N维坐标。以二维坐标举例，笛卡尔坐标为(x, y)，齐次坐标为(x, y, w)。齐次坐标常用的性质有以下几点。
- 齐次坐标与普通坐标的相互转换
当w不为0时，齐次坐标和普通坐标表示的都是点。
齐次坐标(x, y, w)转换为普通坐标为$(\frac{x}{w}, \frac{y}{w})$
普通坐标(x, y)转换为齐次坐标为(xw, yw, w)
当w为0时，齐次坐标和普通坐标表示的都是向量或无穷远处的点。
齐次坐标(x, y, 0)的普通坐标是(x, y)，普通坐标(x, y)的其次坐标是(x, y, 0)。
- 齐次坐标的直线可以相交
$Ax + By + C = 0$, $Ax + By + D = 0$在笛卡尔坐标系里该方程无解。
但是在齐次坐标中，用$\frac{x}{w}$，$\frac{y}{w}$代替x，y，
$A\frac{x}{w} + B\frac{x}{w} + C = 0$，$A\frac{x}{w} + B\frac{x}{w} + D = 0$，即
$Ax + By + Cw = 0$, $Ax + By + Dw = 0$，二者交与(x, y, 0)，这个点在无穷远处。
也就是常见的近大远小的透视效果。
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fvhgnx23ewj2074074dg8.jpg)
#### 位移、旋转、缩放矩阵的结合顺序
根据矩阵的乘法，把多个变换组合到一个矩阵中，这是矩阵变换的最强力之处。由于矩阵乘法不遵守交换律，所有矩阵相乘的顺序很重要。对点(x, y, z)，想要先进行缩放2倍，再位移(2, 0, 0)。很容易知道最终的结果是(2x + 2, 2y, 2z)，写成矩阵相乘的形式为。
$$
\begin{bmatrix}
x & y &z &1
\end{bmatrix}\begin{bmatrix}
2 & 0 & 0 & 0\\ 
0 & 2 & 0 & 0\\ 
0 & 0 & 2 & 0\\ 
0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 & 0\\ 
0 & 1 & 0 & 0\\ 
0 & 0 & 1 & 0\\ 
2 & 0 & 0 & 1
\end{bmatrix} =
\begin{bmatrix}
x & y &z &1
\end{bmatrix}
\begin{bmatrix}
2 & 0 & 0 & 0\\ 
0 & 2 & 0 & 0\\ 
0 & 0 & 2 & 0\\ 
2 & 0 & 0 & 1
\end{bmatrix}
= \begin{bmatrix}
2x + 2 & 2y & 2z & 1 
\end{bmatrix}
$$
如果矩阵的相乘顺序弄错了，先位移后缩放，得到的结果如下。
$$
\begin{bmatrix}
x & y &z &1
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 & 0\\ 
0 & 1 & 0 & 0\\ 
0 & 0 & 1 & 0\\ 
2 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
2 & 0 & 0 & 0\\ 
0 & 2 & 0 & 0\\ 
0 & 0 & 2 & 0\\ 
0 & 0 & 0 & 1
\end{bmatrix} =
\begin{bmatrix}
x & y &z &1
\end{bmatrix}
\begin{bmatrix}
2 & 0 & 0 & 0\\ 
0 & 2 & 0 & 0\\ 
0 & 0 & 2 & 0\\ 
4 & 0 & 0 & 1
\end{bmatrix}
= \begin{bmatrix}
2x + 4 & 2y & 2z & 1 
\end{bmatrix}
$$
在使用的时候一定要弄清楚矩阵变换的先后顺序。通常，我们会先缩放，后旋转，最后位移来保证三者不会相互影响，也最符合直观上的理解。
### 渲染管线中常用矩阵的推导
在渲染管线中常用到的矩阵有相机矩阵、正交矩阵、透视矩阵、视口矩阵等，在这里进行这几个矩阵的推导。
#### 相机矩阵
3D渲染需要用到ZBuffer进行物体遮挡关系的判断。ZBuffer一般采用投影变换后的点归一化后的Z值，所以需要在投影变换前将视线移到原点，视线方向朝向Z轴，这也是相机变换的作用。如图中的相机，假设其位置为$eye$，焦点为$look$，和相机UP方向$up$。我们先将相机移动到原点，然后再旋转摄像机，将其视线方向朝向Z轴即可。最终得到的矩阵也就是位移矩阵与旋转矩阵的乘积。
![](http://ww1.sinaimg.cn/large/c5c3a364ly1fvm49qyx00j20bs09ijrg.jpg)
位移矩阵非常的简单，摄像机的位置为eye，将其移动到原点需要位移-eye，即位移矩阵为：
$$
T_{cam}^{-1} = 
\begin{bmatrix}
1 & 0 & 0 & 0\\ 
0 & 1 & 0 & 0\\ 
0 & 0 & 1 & 0\\ 
-eye.x & -eye.y & -eye.z & 1
\end{bmatrix}
$$
接下来是求旋转矩阵。我们可以先将原坐标系旋转为摄像机朝向的旋转矩阵求出来，其逆矩阵便是将摄像机的朝向旋转到z轴所需要的矩阵。摄像机的朝向$look-eye$实际上就是变换后的z轴基向量，记为$zaxis$，将摄像机的上方向与$zaxis$叉乘可以得到变换后的x轴基向量，记为$xaxis$，再将$zaxis$与$xaxis$乘即得变换后的y轴基向量，记为$yaxis$。
所以由原坐标系旋转为摄像机朝向的矩阵为：
$zaxis = look - eye$
$xaxis = cross(up, zxis)$
$yaxis = cross(zaxis, yaxis)$
$R_{cam} = \begin{bmatrix}
xaxis.x & xaxis.y & xaxis.z & 0\\ 
yaxis.x & yaxis.y & yaxis.z & 0\\ 
zaxis.x & zaxis.y & zaxis.z & 0\\ 
0 & 0 & 0 & 1
\end{bmatrix}$
由于$R_{cam}$是正交矩阵，其逆矩阵为其转置。
$
R_{cam}^{-1} = 
\begin{bmatrix}
xaxis.x & yaxis.x & zaxis.x & 0\\ 
xaxis.y & yaxis.y & zaxis.z & 0\\ 
xaxis.z & yaxis.z & zaxis.z & 0\\ 
0 & 0 & 0 & 1
\end{bmatrix}$
所以可以求得世界坐标到相机坐标的变换矩阵为
$$
M = T_{cam}^{-1}R_{cam}^{-1} = 
\begin{bmatrix}
xaxis.x & yaxis.x & zaxis.x & 0\\ 
xaxis.y & yaxis.y & zaxis.z & 0\\ 
xaxis.z & yaxis.z & zaxis.z & 0\\ 
dot(-eye, xaxis) & dot(-eye, yaxis) & dot(-eye, zaxis) & 1
\end{bmatrix}
$$
#### 正交矩阵
#### 透视矩阵
#### 视口矩阵

https://www.cnblogs.com/bobyguo/articles/1263355.html
https://www.cnblogs.com/daihanlong/articles/3389708.html
http://www.codecogs.com/latex/eqneditor.php
http://www.sohu.com/a/237124232_717210
https://www.cnblogs.com/hexue/p/6215282.html