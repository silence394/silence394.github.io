---
title: 渲染管线的基础数学
categories: 渲染
---
此篇文章总结一下3D渲染用到的基础数学变换，对渲染管线有一个更清晰的认识。假设读者已经对渲染管线有了一个大致的认知，不会花太多篇幅将渲染关系各个阶段的作用。
### 渲染管线
渲染管线是经过一系列的数学变换，将3D空间中的点，变换到屏幕空间，并进行着色的过程。
包含的流程如下：
```
graph LR
物体空间-->世界空间
世界空间-->相机空间
相机空间-->裁剪空间
裁剪空间-->标准设备空间
标准设备空间-->视口空间
视口空间-->图元装配
图元装配-->光栅化
光栅化-->光照&着色
光照&着色-->光栅操作
```
如下图，顶点经过从世界空间变换到投影空间，投影空间下的顶点经过透视除法转换为标准设备空间坐标，再变换到视口下的坐标，将顶点组织成图元，光栅化着色并显示。
![image](https://i.loli.net/2018/09/13/5b9a7ab5a36b9.png)
![IMAGE](https://i.loli.net/2018/09/13/5b9a7ceaa9510.png)

这一系列变换实际上是对点和向量的数学运算，在3D渲染中采用了矩阵用于点和向量的变换。

### 矩阵
#### 矩阵的引入
先介绍一下为什么矩阵可以表示变换。

考虑一个向量**V**
$$
V = \begin{bmatrix}
x & y & z 
\end{bmatrix}
= \begin{bmatrix}
x & 0 & 0 
\end{bmatrix}
+
\begin{bmatrix}
0 & y & 0 
\end{bmatrix}
+
\begin{bmatrix}
0 & 0 & z 
\end{bmatrix}
= x\begin{bmatrix}
1 & 0 & 0 
\end{bmatrix}
+
y\begin{bmatrix}
0 & 1 & 0 
\end{bmatrix}
+
z\begin{bmatrix}
0 & 0 & 1 
\end{bmatrix}
$$
也就是向量**V**可以表示为+x, +y, +z轴的单位向量的变换组合。

假设**p**,**q**,**r**分别对应+x,+y,+z轴的单位向量，那么向量**V**就可以表示成**p**,**q**,**r**的线性变换，**p**,**q**,**r**即为基向量。
$$
V = x\mathbf{p} + y\mathbf{q} + z\mathbf{r}
= \begin{bmatrix}
x & y & z 
\end{bmatrix}
\begin{bmatrix}
\mathbf{p} \\ 
\mathbf{q}\\ 
\mathbf{z}
\end{bmatrix}
= \begin{bmatrix}
x & y & z 
\end{bmatrix}
\begin{bmatrix}
p_x & p_y & p_z\\ 
q_x & q_y & q_z\\ 
r_x & r_y & r_z
\end{bmatrix}
$$
那么我们可以定义矩阵**M**，将向量(x, y , z)变换到**V**，即**M**为从(x, y, z)到**V**的变换矩阵。
$$
\boldsymbol{M} = \begin{bmatrix}
p_x & p_y & p_z\\ 
q_x & q_y & q_z\\ 
r_x & r_y & r_z
\end{bmatrix}
$$
在这边文章中我们以行向量进行矩阵的排布，矩阵的每一行都能解释为变换后的基向量。
如果感觉比较难以理解，这个视频[Transmations](https://www.youtube.com/watch?v=kYB8IZa5AuE&feature=youtu.be&list=PLZHQObOWTQDPD3MizzM2xVFitgF8hE_ab&t=193)或OpenGL的[变换](https://learnopengl-cn.github.io/01%20Getting%20started/07%20Transformations/)可以让你对矩阵表示线性变换有个直观的感受。
#### 旋转和缩放矩阵
考虑一个矩阵2x2的矩阵**M**
$$
M = \begin{bmatrix}
1 & 1\\ 
-1 & 1 \\ 
\end{bmatrix}
$$
从这个矩阵中抽取变换后的基向量**p** = [1 1], **q** = [-1 1]，假设原基向量是(1, 0), (-1, 0)，那么矩阵M表示了对向量缩放$\sqrt{1^2 + 1^2} = \sqrt{1^2 + -1^2} = \sqrt{2}$，然后逆时针旋转$45^{\circ}$。

所以，想要缩放某个向量，只需要将向量的各个分量，分别乘以各个轴的缩放因子。如向量**p**(x, y, z)分别乘以各个轴的缩放$s_x$, $s_y$, $s_z$，得$p\mathbf{'}$，

$$
p' =\begin{bmatrix}
 p_x * s_x & p_y * s_y  &  p_z * s_z
\end{bmatrix}
= p
\begin{bmatrix}
s_x & 0 & 0 \\ 
0 & s_y & 0 \\ 
0 & 0 & s_z
\end{bmatrix}
$$

所以缩放矩阵为:
$$
M = \begin{bmatrix}
s_x & 0 & 0 \\ 
0 & s_y & 0 \\ 
0 & 0 & s_z
\end{bmatrix}
$$

接下来看旋转矩阵，先在2D坐标系里看向量的旋转。在XOY坐标系内任意一点**v**(x, y),其与x轴的夹角为α度，将其旋转β度，得到**v'**，此时**v'** 与x轴的夹角为(α+β)度。假设**v**的长度为**r**,用极坐标表示点，得$x = rcosα$，$y = r\sin \alpha$，$x' = r\cos \left ( \alpha + \beta \right )$，$y' = r\sin \left ( \alpha + \beta \right )$，那么根据三角函数可得，
$x' = r\left ( \cos \alpha \cos \beta  - \sin \alpha \sin \beta  \right ) = 
\begin{bmatrix}
r\cos \alpha & r\sin \alpha
\end{bmatrix} \begin{bmatrix}
\cos \beta\\
-\sin \beta \\ 
\end{bmatrix}$
$y' = r\left ( \cos \alpha \sin \beta  + \sin \alpha \cos \beta  \right ) = 
\begin{bmatrix}
r\cos \alpha & r\sin \alpha
\end{bmatrix} \begin{bmatrix}
\sin\beta\\
\cos \beta \\ 
\end{bmatrix}$
可以得到旋转矩阵为
$$
M = \begin{bmatrix}
\cos \beta & \sin \beta\\ 
-\sin \beta & \cos \beta \\ 
\end{bmatrix}
$$

https://www.cnblogs.com/bobyguo/articles/1263355.html
https://www.cnblogs.com/daihanlong/articles/3389708.html
http://www.codecogs.com/latex/eqneditor.php
http://www.sohu.com/a/237124232_717210